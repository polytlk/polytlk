---
# Source: api/templates/apidefinitions.yaml
apiVersion: tyk.tyk.io/v1alpha1
kind: ApiDefinition
metadata:
  name: eden-api
spec:
  name: eden-api
  use_standard_auth: true
  protocol: http
  active: true
  proxy:
    target_url: http://eden-svc.eden.svc:7079
    listen_path: /api/chinese
    strip_listen_path: true
  CORS:
    enable: true
    allowed_origins:
    - "http://localhost:4200"
    allowed_methods:
    - "GET"
    - "POST"
    - "OPTIONS"
    allowed_headers: []
    exposed_headers: []
    allow_credentials: false
    max_age: 24
    options_passthrough: true
  custom_middleware:
    driver: otto
    pre:
    - name: "sseAuthMiddlewarePreHook"
      path: "middleware/sse-auth-pre-middleware.js"
      require_session: false
  version_data:
    default_version: Default
    not_versioned: true
    versions:
      Default:
        name: Default
        use_extended_paths: true
        global_headers:
          Authorization: "Bearer $tyk_meta.jwt"
---
# Source: api/templates/delete-api-jobs.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: delete-apis-job
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
        - name: delete-apis
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Delete APIs
              kubectl delete apidefinition.tyk.tyk.io --all --namespace eden

              # Remove finalizers
              for api in $(kubectl get apidefinition.tyk.tyk.io -o jsonpath='{.items[*].metadata.name}' --namespace eden); do
                kubectl patch apidefinition.tyk.tyk.io $api --type=json -p='[{"op": "remove", "path": "/metadata/finalizers"}]' --namespace eden
              done
      restartPolicy: OnFailure

